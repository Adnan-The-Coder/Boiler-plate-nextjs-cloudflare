FROM node:18-alpine

# Install Bun
RUN apk add --no-cache curl unzip
RUN curl -fsSL https://bun.sh/install | bash

# Set environment variables to match Cloudflare Pages
ENV NODE_VERSION=18
ENV BUN_VERSION=latest
ENV CF_PAGES=1
ENV CF_PAGES_BRANCH=${GITHUB_REF_NAME:-dev}
ENV CF_PAGES_COMMIT_SHA=${GITHUB_SHA:-local}
ENV CF_PAGES_URL=http://localhost:8788

WORKDIR /app

# Copy package.json and install dependencies
COPY package.json .
COPY bun.lockb .
RUN ~/.bun/bin/bun install

# Copy the rest of the application
COPY . .

# Build the application
RUN ~/.bun/bin/bun run build

# Simulate Cloudflare Pages deployment process
RUN echo "🚀 Starting Cloudflare Pages deployment simulation..."
RUN echo "📦 Packaging build output..."
RUN echo "🔍 Analyzing build output..."
RUN echo "✅ Build validation complete"

# Start the application to verify it works
CMD ["sh", "-c", "echo '📋 Deployment Logs:' && \
     echo '✓ Initialized build environment' && \
     echo '✓ Installed dependencies' && \
     echo '✓ Built application successfully' && \
     echo '✓ Optimized assets' && \
     echo '✓ Prepared for deployment' && \
     echo '✓ Simulated deployment complete' && \
     echo '🌐 Your site would be available at: https://${CF_PAGES_BRANCH}.your-project-name.pages.dev' && \
     ~/.bun/bin/bun run start"]